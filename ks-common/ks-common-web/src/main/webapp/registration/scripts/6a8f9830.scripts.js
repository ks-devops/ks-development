"use strict";angular.module("regCartApp",["configuration","ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router","ui.bootstrap"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/myCart");var d={templateUrl:"partials/cart.html",controller:"CartCtrl"},e={templateUrl:"partials/schedule.html",controller:"ScheduleCtrl"};a.state("root",{"abstract":!0,views:{root:{templateUrl:"partials/main.html",controller:"MainCtrl"}}}).state("root.schedule",{url:"/mySchedule",views:{"":e,mycart:d,schedule:e}}).state("root.cart",{url:"/myCart",views:{"":e,mycart:d,schedule:e}}).state("root.search",{url:"/search",views:{"":{templateUrl:"partials/search.html"},mycart:d,schedule:e}}).state("root.search.results",{url:"/{searchCriteria}",views:{"":{templateUrl:"partials/searchResults.html",controller:"SearchCtrl"}}}).state("root.search.details",{url:"/{searchCriteria}/{id}",templateUrl:"partials/searchDetails.html",controller:"SearchDetailsCtrl"}),c.interceptors.push("loginInterceptor")}]),angular.module("configuration",[]).value("APP_URL","ks-with-rice-bundled-dev/services/").value("DEFAULT_TERM","kuali.atp.2012Fall").value("FEATURE_TOGGLES",{searchDetails:{directAddToWaitlist:!1}}),angular.module("regCartApp").constant("URLS",{scheduleOfClasses:"ScheduleOfClassesClientService",courseRegistration:"CourseRegistrationClientService",courseRegistrationCart:"CourseRegistrationCartClientService",developmentLogin:"DevelopmentLoginClientService"}).constant("STATE",function(){var a={failed:"kuali.lpr.trans.state.failed",processing:"kuali.lpr.trans.state.processing",succeeded:"kuali.lpr.trans.state.succeeded",item:{failed:"kuali.lpr.trans.item.state.failed",processing:"kuali.lpr.trans.item.state.processing",succeeded:"kuali.lpr.trans.item.state.succeeded",waitlist:"kuali.lpr.trans.item.state.waitlist",waitlistActionAvailable:"kuali.lpr.trans.item.state.waitlistActionAvailable"}};return{lpr:a,action:[a.item.waitlistActionAvailable],error:[a.failed,a.item.failed],processing:[a.processing,a.item.processing],success:[a.succeeded,a.item.succeeded],waitlist:[a.item.waitlist]}}()).constant("STATUS",{action:"action",editing:"editing",error:"error","new":"new",processing:"processing",success:"success",waitlist:"waitlist"}).constant("COURSE_TYPES",{registered:"registered",waitlisted:"waitlist",cart:"cart"}).constant("GRADING_OPTION",{audit:"kuali.resultComponent.grade.audit",letter:"kuali.resultComponent.grade.letter",passFail:"kuali.resultComponent.grade.passFail"}).constant("ACTION_LINK",{removeItemFromCart:"removeItemFromCart",undoDeleteCourse:"undoDeleteCourse"}).constant("VALIDATION_ERROR_TYPE",{maxCredits:"kuali.lpr.trans.message.credit.load.exceeded",timeConflict:"kuali.lpr.trans.message.time.conflict",waitlistAvailable:"kuali.lpr.trans.message.waitlist.available",waitlistWaitlisted:"kuali.lpr.trans.message.waitlist.waitlisted",waitlistFull:"kuali.lpr.trans.message.waitlist.full",waitlistNotOffered:"kuali.lpr.trans.message.waitlist.not.offered",transactionException:"kuali.lpr.trans.message.exception",transactionItemException:"kuali.lpr.trans.item.message.exception"}).constant("GENERAL_ERROR_TYPE",{noRegGroup:"noRegGroup"}).constant("VALIDATION_SUCCESS_TYPE",{waitlistStudentRemoved:"kuali.lpr.trans.message.waitlist.student.removed",waitlistUpdated:"kuali.lpr.trans.message.waitlist.options.updated",courseUpdated:"kuali.lpr.trans.message.course.updated",courseDropped:"kuali.lpr.trans.message.course.dropped",personRegistered:"kuali.lpr.trans.message.person.registered"}).constant("DAY_CONSTANTS",{monday:"M",tuesday:"Tu",wednesday:"W",thursday:"Th",friday:"F",saturday:"Sa",sunday:"Su",dayArray:["M","Tu","W","Th","F","Sa","Su"]}),angular.module("regCartApp").constant("SEARCH_FACETS",[{label:"Seats",id:"seatsAvailable",autoCollapse:!1,optionsProvider:function(a){var b=0;angular.forEach(a,function(a){a.seatsAvailable>0&&b++});var c=[];return b>0&&c.push({label:"Seats available",value:"seatsAvailable",count:b}),c},filter:function(a){return a.seatsAvailable>0}},{label:"Credits",id:"creditOptions",optionsKey:"creditOptions",refine:function(a){var b=[];return angular.forEach(a,function(a){var c=Math.floor(a.value),d=c;c>6&&(c=6,d="6+");for(var e=null,f=0;f<b.length;f++)if(-1!==b[f].value.indexOf(c)){e=b[f];break}null===e?(a.label=d,a.count=0,a.value=[a.value],-1===a.value.indexOf(c)&&a.value.push(c),b.push(a)):(-1===e.value.indexOf(a.value)&&e.value.push(c),e.label=d)}),b}},{label:"Course Level",id:"courseLevel",optionsKey:"courseLevel"},{label:"Course Prefix",id:"coursePrefix",optionsKey:"coursePrefix"}]),angular.module("regCartApp").controller("MainCtrl",["$scope","$location","$state","TermsService","ScheduleService","GlobalVarsService","APP_URL","DEFAULT_TERM","LoginService","MessageService","$modal",function(a,b,c,d,e,f,g,h,i,j,k){console.log("In Main Controller"),a.appUrl=g.replace("/services/","/"),a.termId=null,a.termName="",a.studentIsEligibleForTerm=!0,a.$watch("termId",function(b,c){b!==c&&(a.termName=d.getTermNameForTermId(a.terms,b),b===h?(console.log("checking term eligibility"),d.checkStudentEligibilityForTerm().query({termId:b},function(d){a.studentIsEligibleForTerm=angular.isDefined(d.isEligible)&&d.isEligible||!1,a.studentIsEligibleForTerm?a.$broadcast("termIdChanged",b,c):(f.setUserId(d.userId),a.userId=f.getUserId)},function(b){console.log("Error while checking if term is open for registration",b),a.studentIsEligibleForTerm=!1})):(console.log("term eligibility check bypassed - term != default term"),a.studentIsEligibleForTerm=!0,a.$broadcast("termIdChanged",b,c)))}),a.$on("termIdChanged",function(b,c){e.getSchedule(c).then(function(b){console.log("called rest service to get schedule data - in main.js"),f.updateScheduleCounts(b),a.cartCredits=f.getCartCredits,a.cartCourseCount=f.getCartCourseCount,a.registeredCredits=f.getRegisteredCredits,a.registeredCourseCount=f.getRegisteredCourseCount,a.waitlistedCredits=f.getWaitlistedCredits,a.waitlistedCourseCount=f.getWaitlistedCourseCount,a.showWaitlistedSection=f.getShowWaitlistedSection,a.userId=f.getUserId})}),d.getTerms().then(function(b){a.terms=b,a.termId=h,a.termName=d.getTermNameForTermId(b,a.termId)}),j.getMessages().then(function(b){a.messages=b}),a.logout=function(){i.logout().query({},function(){console.log("Logging out"),location.reload()})},a.goToPage=function(a){console.log("Navigating to page: "+a),b.url(a)},a.$on("sessionExpired",function(){console.log("Received event sessionExpired"),k.open({backdrop:"static",templateUrl:"sessionExpired.html",controller:"SessionCtrl",size:"sm"})}),a.$parent.uiState=c.current.name,a.$on("$stateChangeStart",function(b,c){a.$parent.uiState=c.name})}]).controller("SessionCtrl",["$scope","LoginService",function(a,b){a.logout=function(){b.logout().query({},function(){console.log("Session expired...logging out"),location.reload()})}}]),angular.module("regCartApp").controller("CartCtrl",["$scope","$modal","$timeout","STATE","STATUS","GRADING_OPTION","ACTION_LINK","COURSE_TYPES","GENERAL_ERROR_TYPE","CartService","ScheduleService","GlobalVarsService",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){j.getCart(b).then(function(b){a.cart=b;var c=[],f=null;angular.forEach(a.cart.items,function(b){if(t(b),l.getCorrespondingStatusFromState(b.state)===e.processing){b.status=e.processing;var g=angular.copy(b);a.cartResults.items.push(g),a.cartResults.state=d.lpr.processing,a.cartResults.status=e.processing,f=b.cartId}else c.push(b)}),a.cart.items=c,null!==f&&o(f)})}function n(b,d,f){a.courseAdded=!1,b.courseCode&&(b.courseCode=b.courseCode.toUpperCase()),j.addCourseToCart().query({cartId:a.cart.cartId,termId:a.termId,courseCode:b.courseCode||null,regGroupCode:b.regGroupCode||null,regGroupId:b.regGroupId||null,gradingOptionId:b.gradingOptionId||null,credits:b.credits||null},function(b){console.log("Searched for course: "+a.courseCode+" "+a.regCode+", Term: "+a.termId),a.courseCode="",a.regCode="",t(b),a.cart.items.unshift(b),console.log("Started to glow..."),b.addingNewCartItem=!0,c(function(){b.addingNewCartItem=!1},2e3),a.courseAdded=!0,angular.isFunction(d)&&d(b)},function(c){404===c.status?(a.userMessage={txt:c.data,messageKey:i.noRegGroup,type:e.error,course:b.courseCode},a.courseAdded=!0,angular.isFunction(f)&&f(a.userMessage)):400===c.status?(s(c.data,function(a){n(a,d,f)}),a.courseAdded=!0):(console.log("Error with adding course",c.data.consoleMessage),a.userMessage={txt:c.data.genericMessage,messageKey:i.noRegGroup,type:c.data.type,detail:c.data.detailedMessage,course:b.courseCode+" ("+b.regGroupCode+")"},a.courseAdded=!0,angular.isFunction(f)&&f(a.userMessage))})}function o(b){k.pollRegistrationRequestStatus(b).then(function(b){console.log("- Stop polling - Success"),a.cart.state=b.state,a.cart.status="",a.cartResults.state=d.lpr.item.succeeded,angular.forEach(b.responseItemResults,function(b){angular.forEach(a.cartResults.items,function(a){if(a.cartItemId===b.registrationRequestItemId)switch(a.state=b.state,a.type=b.type,a.status=l.getCorrespondingStatusFromState(b.state),a.statusMessages=b.messages,a.status){case e.waitlist:case e.action:a.waitlistMessage=l.getCorrespondingMessageFromStatus(a.status)}})}),p(!0),k.getSchedule(a.termId,!0).then(function(b){console.log("called rest service to get schedule data - in cart.js"),l.updateScheduleCounts(b),a.registeredCredits=l.getRegisteredCredits,a.registeredCourseCount=l.getRegisteredCourseCount})},function(a){console.log("- Stop polling - Error: ",a)},function(b){console.log("- Continue polling"),a.cart.state=b.state})}function p(b){b&&(a.cartResults.successCount=0,a.cartResults.waitlistCount=0,a.cartResults.waitlistedCount=0,a.cartResults.errorCount=0);var c=0,d=0,f=0,g=0;angular.forEach(a.cartResults.items,function(a){switch(a.status){case e.success:c++;break;case e.waitlist:c++,f++;break;case e.action:d++;break;case e.error:g++}}),a.cartResults.successCount=c,a.cartResults.waitlistCount=d,a.cartResults.waitlistedCount=f,a.cartResults.errorCount=g}function q(){if(!a.cart)return 0;for(var b=0,c=0;c<a.cart.items.length;c++)b+=Number(a.cart.items[c].credits);return b}function r(b,c,e){return b.credits&&b.gradingOptionId?void k.registerForRegistrationGroup().query({courseCode:b.courseCode||null,regGroupId:b.regGroupId||null,gradingOption:b.gradingOptionId||null,credits:b.credits||null,allowWaitlist:b.allowWaitlist||!0},function(b){k.pollRegistrationRequestStatus(b.id).then(function(b){var f=null;angular.forEach(b.responseItemResults,function(a){null===f&&(f=a.state)}),f===d.lpr.item.failed?angular.isFunction(e)&&e(b):(k.getSchedule(a.termId,!0).then(function(b){console.log("called rest service to get schedule data - in cart.js"),l.updateScheduleCounts(b),a.registeredCredits=l.getRegisteredCredits,a.registeredCourseCount=l.getRegisteredCourseCount}),angular.isFunction(c)&&c(b))},e)},e):void s(b,function(a){b.gradingOptionId=a.gradingOptionId,b.credits=a.credits,r(b,c,e)})}function s(a,c){b.open({backdrop:"static",templateUrl:"partials/additionalOptions.html",size:"sm",resolve:{item:function(){return a}},controller:["$scope","item",function(a,b){console.log("Controller for modal... Item: ",b);var d=null;angular.isDefined(b.gradingOptions[f.letter])?d=f.letter:angular.forEach(b.gradingOptions,function(a,b){null===d&&(d=b)}),b.gradingOptionId=b.newGrading=d,b.credits=b.newCredits=b.creditOptions[0],a.newCartItem=b,a.newCartItem.editing=!0,a.dismissAdditionalOptions=function(){console.log("Dismissing credits and grading"),a.$close(!0)};var e=!1;a.saveAdditionalOptions=function(b){e||(e=!0,b.editing=!1,a.newCartItem.credits=a.newCartItem.newCredits,a.newCartItem.gradingOptionId=a.newCartItem.newGrading,c(a.newCartItem),a.$close(!0))}}]})}function t(a){a.longName=a.courseTitle,a.gradingOptionId=a.grading}a.states=d,a.statuses=e,a.courseTypes=h,a.oneAtATime=!1,a.isCollapsed=!0,a.cartResults={items:[]},a.$on("termIdChanged",function(b,c){console.log("term id has changed - cart: "+c),a.cartResults.items.splice(0,a.cartResults.items.length),a.userMessage&&a.userMessage.txt&&a.removeUserMessage(),m(c)}),a.$watchCollection("cart.items",function(b){a.creditTotal=q(),b&&l.setCartCredits(a.creditTotal),l.setCartCourses(b)}),a.termId&&m(a.termId),a.courseIndex=function(a){return angular.isDefined(a.index)&&a.index||(a.index=l.getCourseIndex(a)),a.index},a.getStatusMessageFromStatus=function(a){var b="";return a===e.success?b=" - Success!":(a===e.error||a===e.action)&&(b=" - Failed"),b},a.addRegGroupToCart=function(){n({courseCode:a.courseCode,regGroupCode:a.regCode})},a.$on("addCourseToCart",function(a,b,c,d){n(b,c,d)}),a.$on("registerForCourse",function(a,b,c,d){r(b,c,d)}),a.addCartItemToCart=function(a){n(a)},a.cancelNewCartItem=function(){a.newCartItem=null,a.showNew=!1},a.$on("deleteCartItem",function(b,c){var d=c.actionLinks,f=null;angular.forEach(d,function(a){a.action===g.removeItemFromCart&&(f=a.uri)}),j.removeItemFromCart(f).query({},function(b){console.log("Cart item removed",b),a.cart.items.splice(a.cart.items.indexOf(c),1);var d=null;angular.forEach(b.actionLinks,function(a){a.action===g.undoDeleteCourse&&(d=a.uri)}),a.userMessage={txt:"Removed <b>"+c.courseCode+"("+c.regGroupCode+")</b>",actionLink:d,linkText:"Undo",type:e.success}})}),a.$on("updateCourse",function(b,c,d,e,f,g){c===h.cart&&(console.log("Updating cart item"),j.updateCartItem().query({cartId:a.cart.cartId,cartItemId:d.cartItemId,credits:e.credits,gradingOptionId:e.gradingOptionId},function(){console.log("- Cart item successfully updated"),angular.isFunction(f)&&f()},function(a){console.log("- Error updating cart item",a),angular.isFunction(g)&&g(a.genericMessage)}))}),a.invokeActionLink=function(b){j.invokeActionLink(b).query({},function(b){t(b),a.cart.items.unshift(b),a.removeUserMessage()})},a.addCartItemToWaitlist=function(a){console.log("Adding cart item to waitlist... "),k.registerForRegistrationGroup().query({courseCode:a.courseCode,regGroupId:a.regGroupId,gradingOption:a.gradingOptionId,credits:a.credits,allowWaitlist:!0},function(b){a.state=d.lpr.item.processing,a.status=e.processing,a.cartItemId=b.registrationRequestItems[0].id,c(function(){console.log("Just waited 250, now start the polling"),o(b.id)},250)})},a.removeAlertMessage=function(a){a.alertMessage=null},a.removeUserMessage=function(){a.userMessage&&(a.userMessage.txt=null,a.userMessage.linkText=null)},a.removeCartResultItem=function(b){a.cartResults.items.splice(b,1),p()},a.register=function(){j.submitCart().query({cartId:a.cart.cartId},function(b){console.log("Submitted cart. RegReqId["+b.id+"]"),a.removeUserMessage(),a.cartResults=angular.copy(a.cart),a.cart.items.splice(0,a.cart.items.length),a.showConfirmation=!1,a.cartResults.state=d.lpr.processing,a.cartResults.status=e.processing,a.creditTotal=0,angular.forEach(a.cartResults.items,function(a){a.state=d.lpr.item.processing,a.status=e.processing}),c(function(){console.log("Just waited 250, now start the polling"),o(b.id)},250)})}}]),angular.module("regCartApp").controller("ScheduleCtrl",["$scope","$modal","$timeout","STATUS","GRADING_OPTION","COURSE_TYPES","ScheduleService","GlobalVarsService",function(a,b,c,d,e,f,g,h){function i(b,c,d,e,i,j){i(j,function(i){console.log("- Drop course registration request submitted - starting to poll for request status"),g.pollRegistrationRequestStatus(i.id).then(function(){switch(console.log("-- Stop polling - Success"),b){case f.waitlisted:h.removeWaitlistedCourse(c),k++;break;case f.registered:h.removeRegisteredCourse(c),l++}angular.isFunction(d)&&d(),a.$emit("courseDropped",c,b)},function(a){console.log("-- Stop polling - Error",a),angular.isFunction(e)&&e(a.responseItemResults[0].messages[0])},function(){console.log("-- Continue polling")})},function(a){console.log("- Drop course registration request failed",a),angular.isFunction(e)&&e(a.data)})}function j(a,b,c,d,e,i,j){i(j,function(i){console.log("- Update course registration request submitted - starting to poll for request status"),g.pollRegistrationRequestStatus(i.id).then(function(){switch(console.log("-- Stop polling - Success"),a){case f.waitlisted:h.updateWaitlistedCourse(b,c);break;case f.registered:h.updateRegisteredCourse(b,c)}angular.isFunction(d)&&d()},function(a){console.log("-- Stop polling - Error",a),angular.isFunction(e)&&e(a.responseItemResults[0].messages[0])},function(){console.log("-- Continue polling")})},function(a){console.log("- Update course registration request failed",a),angular.isFunction(e)&&e(a.data)})}a.getSchedules=h.getSchedule,a.registeredCredits=h.getRegisteredCredits,a.registeredCourseCount=h.getRegisteredCourseCount,a.waitlistedCredits=h.getWaitlistedCredits,a.waitlistedCourseCount=h.getWaitlistedCourseCount,a.userId=h.getUserId,a.courseTypes=f;var k=0,l=0;a.showWaitlist=function(){return a.waitlistedCredits()>0||k>0},a.showSchedule=function(){return a.showWaitlist()||a.registeredCredits()>0||l>0},a.showGrid=function(){var a=!1;return angular.forEach(h.getCartCourses(),function(b){angular.forEach(b.schedule,function(b){if(!a)for(var c=b.activityOfferingLocationTime,d=0;d<c.length;d++)if(!c[d].isTBA){a=!0;break}})}),a||angular.forEach(h.getScheduledCourses(),function(b){angular.forEach(b.activityOfferings,function(b){if(!a)for(var c=b.scheduleComponents,d=0;d<c.length;d++)if(!c[d].isTBA){a=!0;break}})}),a},a.$on("courseStatusMessageRemoved",function(a,b){switch(b){case f.waitlisted:k--;break;case f.registered:l--}}),a.$on("dropCourse",function(a,b,c,d,e){switch(b){case f.waitlisted:console.log("Drop waitlisted course"),i(b,c,d,e,g.dropFromWaitlist().query,{masterLprId:c.masterLprId});break;case f.registered:console.log("Drop registered course"),i(b,c,d,e,g.dropRegistrationGroup().query,{masterLprId:c.masterLprId})}}),a.$on("updateCourse",function(b,c,d,e,h,i){switch(c){case f.waitlisted:console.log("Update waitlisted course"),j(c,d,e,h,i,g.updateWaitlistItem().query,{courseCode:d.courseCode,regGroupId:d.regGroupId,masterLprId:d.masterLprId,termId:a.termId,credits:e.credits,gradingOptionId:e.gradingOptionId});break;case f.registered:console.log("Update registered course"),j(c,d,e,h,i,g.updateScheduleItem().query,{courseCode:d.courseCode,regGroupId:d.regGroupId,masterLprId:d.masterLprId,termId:a.termId,credits:e.credits,gradingOptionId:e.gradingOptionId})}})}]),angular.module("regCartApp").controller("SearchCtrl",["$scope","$rootScope","$filter","$state","SearchService","SEARCH_FACETS",function(a,b,c,d,e,f){function g(){var b=c("facetFilter"),d=[];angular.forEach(a.searchResults,function(c){b(c,a.facets)&&d.push(c)}),a.filteredResults=d}function h(b){if(null!==b&&(null===a.searchCriteria||b!==a.searchCriteria)){if(angular.isFunction(i)&&(i(),i=null),!a.termId)return console.log("Search blocked - no termId exists"),void(i=a.$on("termIdChanged",function(){i(),i=null,h(b)}));console.log('Searching for "'+b+'"'),j=b,e.searchForCourses().query({termId:a.termId,criteria:b},function(c){j===b?(console.log('Search for "'+b+'" complete. Results: '+c.length),a.searchResults=c,a.searchCriteria=b,g()):console.log('Search completed but not the most recent, ignoring results: "'+b+'" !== "'+j+'"')},function(a){console.log("Error searching for courses: ",a)})}}a.facets=f,a.searchCriteria=null,a.searchResults=[],a.filteredResults=[],b.hideForm=!1,a.$on("termIdChanged",function(){var b=a.searchCriteria;a.searchCriteria="",a.searchResults=[],b&&h(b)}),a.$on("$stateChangeSuccess",function(a,b,c){console.log(c),angular.isDefined(c.searchCriteria)&&h(c.searchCriteria)}),a.$watch("facets",g,!0);var i,j="";a.$on("viewDetails",function(b,c){d.go("root.search.details",{searchCriteria:a.searchCriteria,id:c.courseId})})}]).filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}).filter("facetFilter",function(){return function(a,b){var c=!0;return angular.forEach(b,function(b){c&&angular.isArray(b.selectedOptions)&&b.selectedOptions.length>0&&(b.filter(a,b.selectedOptions)||(c=!1))}),c}}),angular.module("regCartApp").controller("SearchDetailsCtrl",["$scope","$rootScope","$state","$filter","$modal","STATUS","FEATURE_TOGGLES","SearchService","GlobalVarsService",function(a,b,c,d,e,f,g,h,i){function j(b){null===b||null!==a.course&&null!==a.course.courseId&&b===a.course.courseId||(console.log('Loading course "'+b+'"'),v=b,h.getCourse().query({courseOfferingId:b},function(c){if(v===b){var e={};angular.isDefined(c.activityOfferingTypes)&&angular.isArray(c.activityOfferingTypes)&&angular.forEach(c.activityOfferingTypes,function(b){d("aoFormatter")(b.activityOfferings),angular.forEach(b.activityOfferings,function(c){c.activityOfferingType=b.activityOfferingType,angular.forEach(c.regGroupInfos,function(a,b){angular.isUndefined(e[b])&&(e[b]={id:b,code:a,aos:[]}),e[b].aos.push(c)}),!a.additionalInfo&&(null!=c.subterm||angular.isArray(c.requisites)&&c.requisites.length>0)&&(a.additionalInfo=!0)})}),a.availableRegGroups=e,a.course=c,a.updateAOStates(),a.singleRegGroup=l()}else console.log('Course load completed but not the most recent, ignoring: "'+b+'" !== "'+v+'"')},function(a){console.log("Error loading course: ",a)}))}function k(c,d){if(a.selectedRegGroup){a.actionType=c,a.actionStatus=null;var e=angular.copy(a.course);e.courseCode=e.courseOfferingCode,e.regGroupId=a.selectedRegGroup.id,e.regGroupCode=a.selectedRegGroup.code,b.$broadcast(d,e,function(){a.actionStatus=f.success},function(){a.actionStatus=f.error})}}function l(){var b=Object.keys(a.availableRegGroups);return 1===b.length?(angular.forEach(a.availableRegGroups[b[0]].aos,function(a){u(a,!0)}),a.selectedRegGroup=o(),!0):!1}function m(){angular.forEach(a.course.activityOfferingTypes,function(b){a.isAOTypeSelected(b)||1!==a.countEligibleAOs(b.activityOfferings)||angular.forEach(b.activityOfferings,function(b){b.selected||b.disabled||(u(b),a.updateAOStates())})})}function n(a){return angular.isDefined(a.isFull)?a:(a.isFull=!1,a.isWaitlistOffered=!0,a.isWaitlistAvailable=!1,a.isWaitlistFull=!1,a.waitlistSeatsAvailable=null,a.waitlistSeatsTaken=0,angular.forEach(a.aos,function(b){!a.isFull&&b.seatsOpen<=0&&(a.isFull=!0),b.seatsOpen<=0&&angular.isNumber(b.maxWaitListSize)&&(a.waitlistSeatsAvailable=angular.isNumber(a.waitlistSeatsAvailable)&&a.waitlistSeatsAvailable>0?Math.min(a.waitlistSeatsAvailable,b.maxWaitListSize):b.maxWaitListSize),a.waitlistSeatsTaken=Math.max(a.waitlistSeatsTaken,b.waitListSize||0)}),a.isWaitlistFull=angular.isNumber(a.waitlistSeatsAvailable)&&a.waitlistSeatsTaken>=a.waitlistSeatsAvailable,a.isWaitlistAvailable=a.isWaitlistOffered&&!a.isWaitlistFull,a)}function o(){if(a.selectedAOs.length===a.course.activityOfferingTypes.length){var b=q();if(1===b.length)return n(b[0])}return null}function p(b){"object"==typeof b&&angular.isDefined(b.activityOfferingType)&&(b=b.activityOfferingType);var c=null;return angular.forEach(a.selectedAOs,function(a){null===c&&a.activityOfferingType===b&&(c=a)}),c}function q(){var b=a.availableRegGroups;return angular.forEach(a.selectedAOs,function(c){if(null===b){b=[];for(var d in c.regGroupInfos)b.push(a.availableRegGroups[d])}else{var e=[];angular.forEach(b,function(a){angular.isDefined(c.regGroupInfos[a.id])&&e.push(a)}),b=e}}),b||[]}function r(b){var c=!0;if(!s(b)&&a.hasSelectedAOs()){c=!1;for(var d=q(),e=0;e<d.length;e++)if(angular.isDefined(b.regGroupInfos[d[e].id])){c=!0;break}}return c}function s(b){return-1!==a.selectedAOs.indexOf(b)}function t(b){a.selectedAOs.splice(a.selectedAOs.indexOf(b),1),b.selected=!1}function u(b,c){var d=p(b.activityOfferingType);null!==d&&t(d),a.selectedAOs.push(b),c||(b.selected=!0)}a.searchCriteria=null,a.course=null,b.hideForm=!0,a.$on("termIdChanged",function(b,d,e){null!==e&&a.searchCriteria&&"root.search.details"===a.uiState&&c.go("root.search.results",{searchCriteria:a.searchCriteria})}),a.$on("$stateChangeSuccess",function(b,c,d){angular.isDefined(d.searchCriteria)&&(a.searchCriteria=d.searchCriteria),angular.isDefined(d.id)&&j(d.id)});var v=null;a.availableRegGroups={},a.selectedAOs=[],a.selectedRegGroup=null,a.singleRegGroup=!1,a.additionalInfo=!1,a.clearSelectedAOs=function(){a.selectedRegGroup=null,a.selectedAOs=[],a.updateAOStates()},a.hasSelectedAOs=function(){return a.selectedAOs.length>0},a.isAOTypeSelected=function(a){var b=p(a);return null!==b},a.allowDirectAddToWaitlist=function(){return g.searchDetails.directAddToWaitlist||!1},a.isSelectedRegGroupInCart=function(){return a.selectedRegGroup&&i.isCourseInCart(a.selectedRegGroup.id)},a.isSelectedRegGroupInWaitlist=function(){return a.selectedRegGroup&&i.isCourseWaitlisted(a.selectedRegGroup.id)},a.addToCart=function(){k("cart","addCourseToCart")},a.addToWaitlist=function(){a.selectedRegGroup&&a.selectedRegGroup.isWaitlistAvailable&&a.allowDirectAddToWaitlist()&&k("waitlist","registerForCourse")},a.removeActionMessage=function(){a.actionType=null,a.actionStatus=!1},a.$on("showSubterm",function(a,b){e.open({templateUrl:"partials/additionalInfo.html",controller:"AdditionalInfoCtrl",size:"sm",resolve:{subterm:function(){return b},requisites:void 0}})}),a.$on("showRequisites",function(a,b){e.open({templateUrl:"partials/additionalInfo.html",controller:"AdditionalInfoCtrl",size:"sm",resolve:{requisites:function(){return b},subterm:void 0}})}),a.$on("toggleAO",function(b,c){a.toggleAO(c.activityOfferingType,c)}),a.toggleAO=function(b,c){var d=!1;if(s(c))t(c);else{if(!r(c))return;u(c),d=!0}a.updateAOStates(),d&&m(),a.selectedRegGroup=o()},a.countEligibleAOs=function(a){var b=0;return angular.forEach(a,function(a){a.disabled||a.selected||b++}),b},a.updateAOStates=function(){angular.forEach(a.course.activityOfferingTypes,function(b){b.showAll&&a.isAOTypeSelected(b)&&(b.showAll=!1),angular.forEach(b.activityOfferings,function(c){c.selected=s(c),c.disabled=!r(c),c.hidden=b.showAll||c.selected?!1:a.isAOTypeSelected(b)?!0:c.disabled})})}}]).controller("AdditionalInfoCtrl",["$scope","subterm","requisites",function(a,b,c){function d(a){var b=new Date(a);return b.getMonth()+1+"/"+b.getDate()+"/"+b.getFullYear()}a.subterm=b,a.requisites=c,a.startDate=function(){return d(b.startDate)},a.endDate=function(){return d(b.endDate)}}]).directive("searchDetailsList",["$timeout",function(a){return{restrict:"E",templateUrl:"partials/searchDetailsList.html",scope:{searchDetails:"="},link:function(b){b.time=!0,b.instr=!1,b.seatsLoc=!1,b.tab="time",b.select=function(a){switch(b.tab=a,a){case"time":b.time=!0,b.instr=!1,b.seatsLoc=!1,b.all=!1;break;case"instr":b.time=!1,b.instr=!0,b.seatsLoc=!1,b.all=!1;break;case"seatsLoc":b.time=!1,b.instr=!1,b.seatsLoc=!0,b.all=!1;break;case"all":b.time=!0,b.instr=!0,b.seatsLoc=!0,b.all=!0}};var c=5;b.limit=c,b.$watch("limit",function(){b.limit<b.searchDetails.length&&a(function(){b.limit+=c},100)})}}}]),angular.module("regCartApp").filter("creditRangeFormatter",function(){return function(a){var b="";if(a&&angular.isArray(a)){if(1===a.length)b=parseFloat(a[0]);else{var c=parseFloat(Math.min.apply(null,a)),d=parseFloat(Math.max.apply(null,a));b=c+"-"+d}b+=" cr"}return b}}).filter("aoFormatter",["DAY_CONSTANTS",function(a){function b(a){return null===a?"":a}function c(a){for(a=""+a;a.length<3;)a="0"+a;return a}function d(a,b){return a='<span class="kscr-Search-result-sort">'+b+"</span>"+a}function e(b){for(var c=[],d=0;d<a.dayArray.length;d++)b.indexOf(a.dayArray[d])>-1&&c.push(d);return c.sort().toString()}return function(a){for(var f=0;f<a.length;f++){var g,h=a[f],i=h.scheduleComponents,j=h.instructors,k="",l="",m="",n="",o="",p=!1;if(i&&angular.isArray(i)&&i.length>0){for(var q=0;q<i.length;q++)k+=b(i[q].days),l+=b(i[q].displayTime),m+=b(i[q].buildingCode)+" "+b(i[q].roomCode),q<i.length-1&&(k+="<br />",l+="<br />",m+="<br />");k=d(k,e(i[0].days))}if(j&&angular.isArray(j)&&j.length>0){for(var r=0;r<j.length;r++)n+=b(j[r].firstName)+" "+b(j[r].lastName),r<j.length-1&&(n+="<br />");n=d(n,j[0].lastName+j[0].firstName)}o+=h.seatsOpen+"/"+h.seatsAvailable,0===h.seatsOpen&&(o='<span class="kscr-Search-results-no-seats">'+o+"</span>",p=!0),o=d(o,c(h.seatsOpen)+c(h.seatsAvailable));var s=!1,t=!1;null!==h.subterm&&(s=!0),angular.isArray(h.requisites)&&h.requisites.length>0&&(t=!0),(s||t)&&(g=""),s&&(g+='<span class="kscr-SearchDetails-icon--subterm" ng-click="$emit(\'showSubterm\', searchResult.subterm); $event.stopPropagation();"></span>'),t&&(s||(g+='<span class="kscr-SearchDetails-icon">&nbsp;</span>'),g+='<span class="kscr-SearchDetails-icon--requisites" ng-click="$emit(\'showRequisites\', searchResult.requisites); $event.stopPropagation();"></span>');var u=h.activityOfferingCode;h.formatted={days:k,time:l,instructor:n,location:m,seatsOpen:o,additionalInfo:g,aoId:u},h.indicator=p}return a}}]),angular.module("regCartApp").filter("formatValidationMessage",["VALIDATION_ERROR_TYPE","GENERAL_ERROR_TYPE","MessageService",function(a,b,c){function d(a,b,c){var d=g(a.messageKey,c),e=[];if(a.courseCode&&e.push({masterLprId:a.masterLprId,courseCode:a.courseCode}),a.conflictingCourses&&angular.forEach(a.conflictingCourses,function(a){e.push(a)}),e.length){var f=null,h=[],i=[];b&&(angular.isDefined(b.cartItemId)?f=b.cartItemId:angular.isDefined(b.masterLprId)&&(f=b.masterLprId));for(var j=0;j<e.length;j++){if(e[j].masterLprId){if(e[j].masterLprId===f||i.indexOf(e[j].masterLprId)>=0)continue;i.push(e[j].masterLprId)}e[j].courseCode&&h.push("<strong>"+e[j].courseCode+"</strong>")}h.length&&(d+=" ("+h.join(", ")+")")}return d}function e(a,b){var c=g(a.messageKey,b);if(a.maxCredits){var d=parseFloat(a.maxCredits);c+=" (<strong>"+d+" credits</strong>)"}return c}function f(a){var b="";return"string"==typeof a.course&&""!==a.txt&&-1!==a.txt.indexOf(a.course)&&(b=a.txt.replace(a.course,"<strong>"+a.course+"</strong>")),b}function g(a,b){return c.getMessage(b,a)}return function(c,h,i){var j="";if(c)if("string"==typeof c)j=c;else if(c.txt)j=c.txt;else if(c.messageKey)switch(c.messageKey){case a.timeConflict:j=d(c,h,i);break;case a.maxCredits:j=e(c,i);break;case b.noRegGroup:j=f(c);break;default:j=g(c.messageKey,i)}return j}}]),angular.module("regCartApp").service("CartService",["$q","ServiceUtilities","URLS",function(a,b,c){var d={};this.getCart=function(b){var c=a.defer();return angular.isDefined(d[b])?c.resolve(d[b]):this.getCartFromServer().query({termId:b},function(a){d[b]=a,c.resolve(a)},function(a){c.reject(a)}),c.promise},this.getCartFromServer=function(){return b.getData(c.courseRegistrationCart+"/searchForCart")},this.addCourseToCart=function(){return b.postData(c.courseRegistrationCart+"/addCourseToCart")},this.removeItemFromCart=function(a){return b.deleteData(a)},this.invokeActionLink=function(a){return b.getData(a)},this.updateCartItem=function(){return b.putData(c.courseRegistrationCart+"/updateCartItem")},this.submitCart=function(){return b.getData(c.courseRegistrationCart+"/submitCart")},this.undoDeleteCourse=function(){return b.getData(c.courseRegistrationCart+"/undoDeleteCourse")}}]),angular.module("regCartApp").service("TermsService",["$q","ServiceUtilities","URLS","DEFAULT_TERM",function(a,b,c,d){var e=d;this.getTermId=function(){return e},this.setTermId=function(a){e=a},this.getTermNameForTermId=function(a,b){var c;return angular.forEach(a,function(a){a.termId===b&&(c=a.termName)}),c};var f=null;this.getTerms=function(){var b=a.defer();return null!==f?b.resolve(f):this.getTermsFromServer().query({termCode:null,active:!0},function(a){f=a,b.resolve(a)},function(a){b.reject(a)}),b.promise},this.checkStudentEligibilityForTerm=function(){return b.getData(c.scheduleOfClasses+"/checkStudentEligibilityForTerm")},this.getTermsFromServer=function(){return b.getArray(c.scheduleOfClasses+"/terms")}}]),angular.module("regCartApp").service("ScheduleService",["$q","$timeout","URLS","STATUS","ServiceUtilities","GlobalVarsService",function(a,b,c,d,e,f){var g={};this.getSchedule=function(b,c){var d=a.defer();return c||(c=!1),angular.isDefined(g[b])&&!c?d.resolve(g[b]):this.getScheduleFromServer().query({termId:b},function(a){g[b]=a,d.resolve(a)},function(a){d.reject(a)}),d.promise},this.pollRegistrationRequestStatus=function(c,e,g){angular.isNumber(e)||(e=1e3),g||(g=a.defer());
var h=this;return b(function(){h.getRegistrationStatus().query({regReqId:c},function(a){var b=f.getCorrespondingStatusFromState(a.state);switch(b){case d.new:case d.processing:g.notify(a),h.pollRegistrationRequestStatus(c,e,g);break;case d.success:g.resolve(a);break;case d.error:g.reject(a)}},function(a){g.reject(a)})},e),g.promise},this.getScheduleFromServer=function(){return e.getData(c.courseRegistration+"/studentSchedule")},this.dropRegistrationGroup=function(){return e.deleteData(c.courseRegistration+"/registrationRequest")},this.registerForRegistrationGroup=function(){return e.postData(c.courseRegistration+"/registrationRequest")},this.updateScheduleItem=function(){return e.putData(c.courseRegistration+"/registrationRequest")},this.dropFromWaitlist=function(){return e.deleteData(c.courseRegistration+"/waitlistRegistrationRequest")},this.updateWaitlistItem=function(){return e.putData(c.courseRegistration+"/waitlistRegistrationRequest")},this.getRegistrationStatus=function(){return e.getData(c.courseRegistration+"/registrationStatus")}}]),angular.module("regCartApp").service("LoginService",["ServiceUtilities","URLS",function(a,b){this.logOnAsAdmin=function(){return a.getData(b.developmentLogin+"/login")},this.logout=function(){return a.getData(b.developmentLogin+"/logout")}}]),angular.module("regCartApp").service("MessageService",["$q","$resource",function(a,b){var c=null;this.getMessages=function(){var b=a.defer();return null!==c?b.resolve(c):this.loadMessages().query({},function(a){c=a,b.resolve(c)},function(a){b.reject(a)}),b.promise},this.getMessage=function(a,b){var c="";return angular.forEach(a,function(a){a.messageKey===b&&(c=a.message)}),c},this.loadMessages=function(){return b("json/messages.json",{},{query:{method:"GET",cache:!1,isArray:!0}})}}]),angular.module("regCartApp").service("SearchService",["ServiceUtilities","URLS",function(a,b){this.searchForCourses=function(){return a.getArray(b.scheduleOfClasses+"/search")},this.getCourse=function(){return a.getData(b.scheduleOfClasses+"/courseOfferingDetails")}}]),angular.module("regCartApp").factory("loginInterceptor",["$q","$injector","$window","$rootScope",function(a,b,c,d){return{response:function(b){var c=b.data;return"object"!=typeof c&&c.indexOf("Kuali Student Login")>-1?(console.log("Informing user that session has expired..."),d.$broadcast("sessionExpired"),a.reject(b)):b},responseError:function(d){if(0===d.status){console.log("Failed to execute request - trying to login");var e=b.get("LoginService");e.logOnAsAdmin().query({userId:"admin",password:"admin"},function(){console.log("Logged in, reloading page."),c.location.reload()},function(){console.log("Not Logged in, reloading page."),c.location.reload()})}return a.reject(d)}}}]),angular.module("regCartApp").service("GlobalVarsService",["STATE","STATUS",function(a,b){function c(a,b){angular.isString(a)&&(a={regGroupId:a});var c=!1;return angular.forEach(b,function(b){c||b.regGroupId!==a.regGroupId||(c=!0)}),c}var d,e,f,g=0,h=0,i=0,j=0,k=0,l={},m=1,n=[],o=[],p=[];this.getCartCredits=function(){return g},this.setCartCredits=function(a){g=a},this.getCartCourseCount=function(){return h},this.setCartCourseCount=function(a){h=a},this.getRegisteredCredits=function(){return d},this.setRegisteredCredits=function(a){d=a},this.getRegisteredCourseCount=function(){return i},this.setRegisteredCourseCount=function(a){i=a},this.getWaitlistedCredits=function(){return j},this.setWaitlistedCredits=function(a){j=a},this.getWaitlistedCourseCount=function(){return k},this.setWaitlistedCourseCount=function(a){k=a},this.getCartCourses=function(){return n},this.setCartCourses=function(a){n.splice(0,n.length),a&&(angular.forEach(a,function(a){n.push(a)}),this.setCartCourseCount(a.length))},this.getRegisteredCourses=function(){return o},this.getWaitlistedCourses=function(){return p},this.getScheduledCourses=function(){return o.concat(p)},this.removeRegisteredCourse=function(a){this.getRegisteredCourses().splice(this.getRegisteredCourses().indexOf(a),1),this.setRegisteredCredits(parseFloat(this.getRegisteredCredits())-parseFloat(a.credits)),this.setRegisteredCourseCount(parseInt(this.getRegisteredCourseCount())-1)},this.removeWaitlistedCourse=function(a){this.getWaitlistedCourses().splice(this.getWaitlistedCourses().indexOf(a),1),this.setWaitlistedCredits(parseFloat(this.getWaitlistedCredits())-parseFloat(a.credits)),this.setWaitlistedCourseCount(this.getWaitlistedCourses().length)},this.updateRegisteredCourse=function(a,b){var c=parseFloat(this.getRegisteredCredits())-parseFloat(a.credits)+parseFloat(b.credits);console.log("registeredCredits = "+c),this.setRegisteredCredits(c)},this.updateWaitlistedCourse=function(a,b){var c=parseFloat(this.getWaitlistedCredits())-parseFloat(a.credits)+parseFloat(b.credits);console.log("waitlistedCredits = "+c),this.setWaitlistedCredits(c)},this.isCourseInCart=function(a){return c(a,this.getCartCourses())},this.isCourseRegistered=function(a){return c(a,this.getRegisteredCourses())},this.isCourseWaitlisted=function(a){return c(a,this.getWaitlistedCourses())},this.getSchedule=function(){return e},this.setSchedule=function(a){e=a},this.getUserId=function(){return f},this.setUserId=function(a){f=a},this.getCorrespondingStatusFromState=function(c){var d=b.new;return a.processing.indexOf(c)>=0?d=b.processing:a.success.indexOf(c)>=0?d=b.success:a.error.indexOf(c)>=0?d=b.error:a.waitlist.indexOf(c)>=0?d=b.waitlist:a.action.indexOf(c)>=0&&(d=b.action),d},this.updateScheduleCounts=function(a){var b=a.studentScheduleTermResults,c=a.userId,d=0,e=0;o.splice(0,o.length),p.splice(0,p.length),this.setSchedule(b),angular.forEach(b,function(a){angular.forEach(a.registeredCourseOfferings,function(a){d+=parseFloat(a.credits),o.push(a);var b=0;angular.forEach(a.gradingOptions,function(){b++}),a.gradingOptionCount=b}),angular.forEach(a.waitlistCourseOfferings,function(a){e+=parseFloat(a.credits),p.push(a);var b=0;angular.forEach(a.gradingOptions,function(){b++}),a.gradingOptionCount=b})}),this.setRegisteredCourseCount(o.length),this.setRegisteredCredits(d),this.setWaitlistedCredits(e),this.setWaitlistedCourseCount(p.length),this.setUserId(c)},this.getCorrespondingMessageFromStatus=function(a){var c="";return a===b.waitlist&&(c="If a seat becomes available you will be registered automatically"),c},this.getCourseIndex=function(a){var b=a.courseCode+(a.regGroup||a.regGroupCode),c=l[b];return isNaN(c)&&(c=m++,l[b]=c),c}}]),angular.module("regCartApp").service("ServiceUtilities",["$resource","APP_URL",function(a,b){function c(a){var b=[];for(var c in a)a[c]&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}this.getData=function(c){return a(b+c,{},{query:{method:"GET",cache:!1,isArray:!1}})},this.deleteData=function(c){return a(b+c,{},{query:{method:"DELETE",cache:!1,isArray:!1}})},this.postData=function(d){return a(b+d,{},{query:{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},method:"POST",cache:!1,isArray:!1,transformRequest:function(a){return c(a)}}})},this.putData=function(d){return a(b+d,{},{query:{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},method:"PUT",cache:!1,isArray:!1,transformRequest:function(a){return c(a)}}})},this.getArray=function(c){return a(b+c,{},{query:{method:"GET",cache:!1,isArray:!0}})}}]),angular.module("regCartApp").service("CourseCalendarDataParser",["DAY_CONSTANTS","GlobalVarsService",function(a,b){function c(){var b={};return b[a.monday]=[],b[a.tuesday]=[],b[a.wednesday]=[],b[a.thursday]=[],b[a.friday]=[],b}function d(a,b,c){return angular.forEach(b,function(b){if(!b.dropped){var d={courseCode:b.courseCode,regGroup:b.regGroupCode};"CART"===c&&angular.isUndefined(b.activityOfferings)&&(b.activityOfferings=[],angular.forEach(b.schedule,function(a){angular.isUndefined(a.scheduleComponents)&&(a.scheduleComponents=[],angular.forEach(a.activityOfferingLocationTime,function(b){a.scheduleComponents.push(b.time)})),angular.isUndefined(a.activityOfferingTypeName)&&(a.activityOfferingTypeName=a.activityOfferingType),b.activityOfferings.push(a)})),angular.forEach(b.activityOfferings,function(f){angular.forEach(f.scheduleComponents,function(f){a=e(a,d,f,c,b)})})}}),a}function e(b,c,d,e,g){return d.isTBA||angular.forEach(a.dayArray,function(a){d.days.indexOf(a)>-1&&(b=f(b,c,d,a,e,g))}),b}function f(b,c,d,e,f,g){if(!d.startTime||!d.endTime)return b;angular.isArray(b[e])||(b[e]=[],e!==a.saturday||angular.isArray(b[a.sunday])||(b[a.sunday]=[]),e!==a.sunday||angular.isArray(b[a.saturday])||(b[a.saturday]=[]));var h=j(d.startTime),i=j(d.endTime);h>i&&(i+=1440);var l={index:k(c),courseCode:c.courseCode,startTime:h,endTime:i,type:f,details:g};return b[e].push(l),b}function g(b){var c=["REG","WAIT","CART"],d=[],e=null,f=null,g=60;return angular.forEach(a.dayArray,function(a){var i=b[a];if(angular.isArray(i)){var j=[],k={};angular.forEach(i,function(a){var b=a.type;angular.isArray(k[b])||(k[b]=[]),k[b].push(a),(null===e||a.startTime-g<e)&&(e=a.startTime-g),(null===f||a.endTime+g>f)&&(f=a.endTime+g)}),angular.forEach(c,function(a){var b=k[a];angular.forEach(b,function(a){j=h(j,a)})});var l={day:a,rows:j};d.push(l)}}),0>e&&(e=0),{timeRange:[e,f],days:d}}function h(a,b){for(var c=!1,d=function(a,b){return a.startTime===b.startTime?0:a.startTime<b.startTime?-1:1},e=0;e<a.length;e++){var f=a[e],g=f.courses;angular.isArray(g)||(g=[]);var h=i(g,b);if(!h){g.push(b),g.sort(d),c=!0;break}}if(!c){var j=[];j.push(b),a.push({courses:j})}return a}function i(a,b){for(var c=!1,d=b.startTime,e=b.endTime,f=0;f<a.length;f++){var g=a[f],h=g.startTime,i=g.endTime;if(i>=d&&e>=h){angular.isArray(b.conflicts)||(b.conflicts=[]),angular.isArray(g.conflicts)||(g.conflicts=[]),b.conflicts.push(g.index),g.conflicts.push(b.index),c=!0;break}}return c}function j(a){var b=a.indexOf(":"),c=a.substring(0,b),d=a.substring(b+1,a.indexOf(" ")),e=-1!==a.toLowerCase().indexOf("pm"),f=60*parseInt(c);return f+=parseInt(d),e&&"12"!==c&&(f+=720),f}function k(a){return b.getCourseIndex(a)}this.buildCalendar=function(a,b,e){var f=c();return a&&(f=d(f,a,"REG")),b&&(f=d(f,b,"WAIT")),e&&(f=d(f,e,"CART")),g(f)}}]),angular.module("regCartApp").directive("courseCalendar",function(){return{restrict:"E",scope:{size:"@"},templateUrl:"partials/courseCalendar.html",controller:["$scope","CourseCalendarDataParser","GlobalVarsService",function(a,b,c){a.courseFilter=function(b){var c=!0;switch(b.type){case"REG":c=!a.hideRegistered;break;case"WAIT":c=!a.hideWaitlisted;break;case"CART":c=!a.hideCart}return c},a.timeFilter=function(b){var c=b.getHours();return a.visibleTimeRange[0]/60<=c&&c<=a.visibleTimeRange[1]/60},a.selectedCourse=null,a.$on("course-clicked",function(b,c){a.selectedCourse=a.selectedCourse&&a.selectedCourse.index===c.index?null:c,a.$apply()}),a.clearSelectedCourse=function(){a.selectedCourse=null};var d=a.size;"small"!==d&&(d="large"),a.calendarSize=d,a.hideRegistered=!1,a.hideWaitlisted=!1,a.hideCart=!1,a.visibleTimeRange=[],a.times=[];for(var e=0;24>e;e++)a.times.push(new Date(0,0,0,e,0,0,0));a.registered=c.getRegisteredCourses(),a.waitlisted=c.getWaitlistedCourses(),a.cart=c.getCartCourses();var f=function(c){if(c){var d=b.buildCalendar(a.registered,a.waitlisted,a.cart);a.visibleTimeRange=[60*Math.floor(d.timeRange[0]/60),60*Math.ceil(d.timeRange[1]/60)],a.days=d.days}};f(!0),a.$watchCollection("registered",f),a.$watchCollection("waitlisted",f),a.$watchCollection("cart",f)}]}}),angular.module("regCartApp").directive("courseCalendarItem",["$timeout","$window",function(a,b){return{restrict:"CAE",scope:!1,link:function(c,d){function e(){var a=c.visibleTimeRange,b=a[1]-a[0],e=c.course.endTime-c.course.startTime,g=100*e/b,h=100*(c.course.startTime-a[0])/b;d.css({left:h+"%",top:h+"%",height:g+"%",width:g+"%"}),f()}function f(){var a=d[0].offsetHeight,b=d.parent();b.height()<a&&b.height(a)}angular.element(b).on("resize",function(){a(f)}),a(e),d.bind("click",function(){c.$emit("course-clicked",c.course)})}}}]),angular.module("regCartApp").directive("courseCard",function(){return{transclude:!0,scope:{schedules:"=",credits:"=",type:"@"},templateUrl:"partials/courseCard.html",controller:"CardCtrl"}}).directive("courseAccordion",function(){return{restrict:"E",transclude:!0,scope:{course:"=",type:"@",cardIndex:"=",cartId:"="},templateUrl:"partials/courseAccordion.html",controller:"CardCtrl"}}).controller("CardCtrl",["$scope","$timeout","GlobalVarsService","TermsService","CartService","ScheduleService","STATUS","GRADING_OPTION","COURSE_TYPES",function(a,b,c,d,e,f,g,h,i){function j(){var b;switch(a.type){case i.waitlisted:b={heading:"Waitlisted",prefix:"waitlisted",prefix2:"waitlist_",prefix3:"waitlist_",remove:"Remove"};break;case i.cart:b={heading:"Cart",prefix:"cart",prefix2:"",prefix3:"cart_",remove:"Remove"};break;default:b={heading:"Registered",prefix:"reg",prefix2:"",prefix3:"schedule_",remove:"Drop"}}return b}function k(a){return a.credits=a.newCredits,a.gradingOptionId=a.newGrading,a}function l(a){var c=angular.copy(a);k(a),a.editing=!1,a.isopen=!1,a.gradingOptionId!==c.gradingOptionId&&(a.editGradingOption=!0,b(function(){a.editGradingOption=!1},2e3)),a.credits!==c.credits&&(a.editCredits=!0,b(function(){a.editCredits=!1},2e3))}a.config=j(),a.courseTypes=i,a.courseOfferings=function(b){var c;switch(a.type){case i.waitlisted:c=b.waitlistCourseOfferings;break;default:c=b.registeredCourseOfferings}return c},a.cancelDropConfirmation=function(a){a.dropping=!1},a.showBadge=function(a){return a.gradingOptionId!==h.letter||a.editGradingOption},a.editItem=function(a){a.newCredits=a.credits,a.newGrading=a.gradingOptionId,a.editing=!0},a.gradingOption=function(b){return b.gradingOptions[a.course.gradingOptionId]},a.courseIndex=function(a){return angular.isDefined(a.index)&&a.index||(a.index=c.getCourseIndex(a)),a.index},a.removeStatusMessage=function(b){b.statusMessage=null,a.$emit("courseStatusMessageRemoved",a.type,b)},a.dropCourse=function(b){switch(a.type){case i.cart:a.$emit("deleteCartItem",b);break;default:console.log("Open drop confirmation"),b.dropping=!0}},a.dropCourseConfirmed=function(b){b.dropping=!1,b.dropProcessing=!0,b.statusMessage={txt:"<strong>"+b.courseCode+" ("+b.regGroupCode+")</strong> drop processing",type:g.processing},a.$emit("dropCourse",a.type,b,function(){b.dropped=!0,b.dropProcessing=!1;var c;switch(a.type){case i.registered:c="<strong>"+b.courseCode+" ("+b.regGroupCode+")</strong> dropped successfully";break;case i.waitlisted:c="Removed from waitlist for <strong>"+b.courseCode+" ("+b.regGroupCode+")</strong> successfully"}b.statusMessage={txt:c,type:g.success}},function(a){b.dropProcessing=!1,b.statusMessage={txt:a,type:g.error}})},a.updateItem=function(b){console.log("Updating "+a.type+" course. Grading: "+b.newGrading+", Credits: "+b.newCredits),b.requestProcessing=!0;var c=angular.copy(b);k(c),a.$emit("updateCourse",a.type,b,c,function(){b.requestProcessing=!1,l(b)},function(a){b.requestProcessing=!1,b.statusMessage={txt:a,type:g.error}})}}]),angular.module("regCartApp").directive("courseOptions",function(){return{restrict:"E",transclude:!0,scope:{course:"=",maxOptions:"@max",prefix:"@",showAll:"@",moreButtonSelectBehavior:"@moreBehavior",cancelFn:"&onCancel",submitFn:"&onSubmit"},templateUrl:"partials/courseOptions.html",controller:["$scope","$modal",function(a,b){function c(a,b,c){if(a.length<=g)return!0;var d=a.indexOf(b),e=a.indexOf(c),f=2,h=Math.max(0,Math.min(d-f,a.length-g)),i=Math.min(h+g,a.length)-1;return e>=h&&i>=e}function d(){var c=a.$new();c.course=angular.copy(f),c.cancel=function(){},c.submit=function(){},f.editing=!1;var d=b.open({backdrop:"static",template:'<div class="kscr-AdditionalOptions"><course-options course="course" show-all="true" max="'+g+'" prefix="modal_'+(a.prefix?a.prefix:"")+'" on-submit="modalSubmit()" on-cancel="modalCancel()"></course-options></div>',scope:c,controller:["$scope",function(a){a.showAllCreditOptions=!0,a.showAllGradingOptions=!0,a.modalCancel=function(){a.$dismiss("cancel")},a.modalSubmit=function(){a.$close(a.course)}}]});d.result.then(function(b){f.newGrading=b.newGrading,f.newCredits=b.newCredits,a.submit()},function(){a.cancel()})}function e(){a.showAllCreditOptions=h,a.showAllGradingOptions=h}var f=a.course,g=a.maxOptions||4,h=a.showAll?!0:!1,i=a.moreButtonSelectBehavior||"expand";a.showAllCreditOptions=h,a.showAllGradingOptions=h,a.gradingOptions=[],f&&f.gradingOptions&&angular.forEach(f.gradingOptions,function(a,b){this.push({key:b,label:a})},a.gradingOptions),a.creditOptionsFilter=function(b){return!f||a.showAllCreditOptions?!0:c(f.creditOptions,f.credits,b)},a.gradingOptionsFilter=function(b){return!f||a.showAllGradingOptions?!0:c(Object.keys(f.gradingOptions),f.grading,b.key)},a.showMoreCreditOptions=function(){"expand"===i?a.showAllCreditOptions=!0:d()},a.showMoreGradingOptions=function(){"expand"===i?a.showAllGradingOptions=!0:d()},a.shouldShowMoreCreditOptionsToggle=function(){return!a.showAllCreditOptions&&f.creditOptions.length>g},a.shouldShowMoreGradingOptionsToggle=function(){return!a.showAllGradingOptions&&Object.keys(f.gradingOptions).length>g},a.cancel=function(){console.log("Canceling options changes"),f.newCredits=f.credits,f.newGrading=f.grading||f.gradingOptionId,f.status="",f.editing=!1,a.cancelFn&&a.cancelFn({course:f}),e()},a.submit=function(){console.log("Submitting options form"),a.submitFn&&a.submitFn({course:f}),e()},a.showGradingHelp=function(){b.open({templateUrl:"partials/gradingOptionsHelp.html"})}}]}}),angular.module("regCartApp").directive("focusMe",["$timeout","$parse",function(a,b){return{link:function(c,d,e){var f=b(e.focusMe);c.$watch(f,function(b){b===!0&&a(function(){d[0].focus()})}),d.bind("blur",function(){a(function(){d[0].focus()})})}}}]).directive("focusOnce",["$timeout","$parse",function(a,b){return{link:function(c,d,e){var f=b(e.focusOnce);c.$watch(f,function(b){b===!0&&a(function(){d[0].focus()})})}}}]).directive("dropMenu",["$window",function(a){return{controller:["$scope",function(b){return angular.element(a).bind("resize",function(){b.dropMenu===!0&&(b.dropMenu=!1)})}],templateUrl:"dropMenu.html"}}]).directive("compile",["$compile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.compile)},function(d){c.html(d),a(c.contents())(b)})}}]);var maskUtils={mask:function(a,b){return b?b.remove():b=angular.element('<div class="util-Mask"/>'),a.append(b),a.addClass("util-Mask--masked"),b},unmask:function(a,b){b&&(b.remove(),b=null,a.removeClass("util-Mask--masked"))},resetZIndex:function(a,b){a.css("zIndex",b)},updateZIndex:function(a,b){var c=b.css("zIndex"),d=a.css("zIndex");return a.css("zIndex",c+1),d}};angular.module("regCartApp").directive("maskScreen",["$timeout","$document",function(a,b){return{restrict:"A",scope:{maskScreen:"="},link:function(c,d){function e(){j=maskUtils.mask(i),j.bind("click",function(){f()}),h=maskUtils.updateZIndex(d,j),k=!0}function f(){maskUtils.unmask(i,j),maskUtils.resetZIndex(d,h),k=!1,a(function(){c.maskScreen=!1})}function g(a){a&&!k?e():!a&&k&&f()}var h,i=b.find("body"),j=null,k=!1;c.$watch("maskScreen",g),g(c.maskScreen),d.bind("$destroy",f)}}}]),angular.module("regCartApp").directive("maskWhen",["$timeout",function(a){return{restrict:"A",scope:{maskWhen:"="},link:function(b,c){function d(){g=maskUtils.mask(c),g.bind("click",function(){e()}),h=!0}function e(){maskUtils.unmask(c,g),h=!1,a(function(){b.maskWhen=!1})}function f(a){a&&!h?d():!a&&h&&e()}var g=null,h=!1;b.$watch("maskWhen",f),f(b.maskWhen),c.bind("$destroy",e)}}}]),angular.module("regCartApp").directive("searchFacet",[function(){return{restrict:"ECA",scope:{facet:"=",results:"="},templateUrl:"partials/searchFacet.html",controller:["$scope",function(a){function b(b,c){return angular.forEach(b,function(a){a.count=0}),angular.forEach(c,function(c){angular.forEach(b,function(b){a.facet.filter(c,b.value)&&b.count++})}),b}function c(c){angular.isFunction(a.facet.prepare)&&a.facet.prepare(c);var d=a.facet.optionsProvider(c);return angular.isFunction(a.facet.refine)&&(d=a.facet.refine(d,c),d=b(d,c)),d}function d(b){a.clearSelectedOptions();var d=c(b);a.options=d,angular.isDefined(a.facet.autoCollapse)&&!a.facet.autoCollapse||1!==d.length||(a.isCollapsed=!0)}angular.isFunction(a.facet.optionsProvider)||(a.facet.optionsProvider=function(b){var c=[];return angular.isDefined(a.facet.optionsKey)&&null!==a.facet.optionsKey?angular.forEach(b,function(b){if(angular.isDefined(b[a.facet.optionsKey])){var d=b[a.facet.optionsKey];angular.isArray(d)||(d=[d]),angular.forEach(d,function(a){var b=null;angular.forEach(c,function(c){null===b&&c.value===a&&(b=c)}),null===b&&(b={label:a,value:a,count:0},c.push(b)),b.count++})}}):console.log('Facet "'+a.facet.id+'" is missing the required optionsKey value'),c.sort(function(a,b){return a.label===b.label?0:a.label<b.label?-1:1}),c}),angular.isFunction(a.facet.filter)||(a.facet.filter=function(b,c){function d(a,b){var c=!1;return angular.isArray(a)?angular.forEach(a,function(a){c||(c=d(a,b))}):angular.isArray(b)?angular.forEach(b,function(b){c||(c=d(a,b))}):c=a===b,c}if(angular.isDefined(a.facet.optionsKey)&&null!==a.facet.optionsKey&&angular.isDefined(b[a.facet.optionsKey])){var e=b[a.facet.optionsKey];return d(e,c)}return!1}),a.options=[],a.facet.selectedOptions=[],a.$watch("results",function(a){d(a)}),a.clearSelectedOptions=function(){a.facet.selectedOptions=[]},a.hasSelected=function(){return a.facet.selectedOptions.length>0},a.isSelected=function(b){return-1!==a.facet.selectedOptions.indexOf(b.value)},a.toggleOption=function(b){var c=a.facet.selectedOptions.indexOf(b.value);-1===c?a.facet.selectedOptions.push(b.value):a.facet.selectedOptions.splice(c,1)}}]}}]),angular.module("regCartApp").directive("searchForm",[function(){return{restrict:"ECA",templateUrl:"partials/searchForm.html",controller:["$scope","$state",function(a,b){function c(){var a=null;return angular.isDefined(b.params)&&angular.isDefined(b.params.searchCriteria)&&(a=b.params.searchCriteria),a}function d(){var d=c();null!==d?d!==a.courseSearchCriteria&&(a.courseSearchCriteria=b.params.searchCriteria):a.courseSearchCriteria=""}a.courseSearchCriteria="",d(),a.$on("$stateChangeSuccess",function(){d()}),a.submit=function(){c()!==a.courseSearchCriteria&&b.go("root.search.results",{searchCriteria:a.courseSearchCriteria})}}]}}]),angular.module("regCartApp").directive("searchList",["$filter","$animate","$timeout",function(a,b,c){return{restrict:"E",require:"^searchResults",templateUrl:"partials/searchList.html",scope:{searchResults:"=?",searchColumns:"=",searchData:"=?",displayLimit:"=?",searchCriteria:"@",termName:"@",detailsId:"@",defaultField:"@",preprocessor:"@",onClick:"@",prefix:"@",showMobile:"@"},link:function(d){b.enabled(!1,angular.element(document.querySelector(".kscr-Search-row"))),angular.isUndefined(d.searchResults)&&d.preprocessor&&(d.searchResults=a(d.preprocessor)(d.searchData));var e=20;d.limit=e,d.$watch("limit",function(){d.limit<d.displayLimit&&c(function(){d.limit+=e},250)}),d.displayLimits=[20,50,100],angular.isUndefined(d.displayLimit)&&(d.displayLimit=d.displayLimits[0]),d.page=1,d.detailsId={},d.reverseMap={},d.lastPage=function(){return Math.ceil(d.searchResults.length/d.displayLimit)},d.pageRange=function(){for(var a=[],b=d.lastPage(),c=1;b>=c;c++)a.push(c);return a},d.$watch("displayLimit",function(){d.page=1}),d.$watch("searchResults",function(){d.page>d.lastPage()&&(d.page=1)}),d.displayRangeMin=function(){return(d.page-1)*d.displayLimit+1},d.displayRangeMax=function(){var a=d.displayRangeMin(),b=a+d.displayLimit-1;return b>d.searchResults.length&&(b=d.searchResults.length),b},d.applyFilter=function(b,c,d){var e=null;if(c&&angular.isUndefined(b[c])&&-1!==c.indexOf(".")){for(var f,g=b,h=c.split("."),i=0;f=h[i],i<h.length;i++){if(!angular.isDefined(g[f])){g=null;break}g=g[f]}null!==g&&(e=g)}else e=b[c];return angular.isArray(e)&&d?a(d)(e):e},d.getId=function(a){return a[d.detailsId]},d.sortColumn=function(a){a.sortable&&(d.predicate=a.field,d.reverse=d.sortResults(a.field))},d.sortResults=function(a){var b;switch(angular.isUndefined(d.reverseMap[a])&&(d.reverseMap[a]=0),d.reverseMap[a]){case 0:d.reverseMap[a]=1,b=!1;break;case 1:d.reverseMap[a]=2,b=!0;break;case 2:d.reverseMap[a]=0,d.predicate=void 0}return b},d.emitEvent=function(a,b){a&&d.$emit(a,b)},d.hasData=function(a){for(var b=!1,c=0;c<d.searchResults.length;c++){var e=d.applyFilter(d.searchResults[c],a);if(e){b=!0;break}}return b},d.$on("clearSelected",function(){angular.forEach(d.searchResults,function(a){a.selected=!1,a.hidden=!1})}),d.$on("hideRow",function(a,b){angular.forEach(d.searchResults,function(a){a[d.defaultField]===b&&(a.hidden=!0)})}),d.$on("showRow",function(a,b){angular.forEach(d.searchResults,function(a){a[d.defaultField]===b&&(a.hidden=!1)})}),d.$on("showAllRows",function(){angular.forEach(d.searchResults,function(a){a.hidden&&(a.hidden=!1)})})}}}]).directive("searchResults",function(){return{restrict:"E",controller:"SearchResultsCtrl"}}).directive("searchColumn",function(){return{restrict:"E",require:"^searchResults",link:function(a,b,c){if(c.name||c.field||c.filter){angular.isArray(a.searchColumns)||(a.searchColumns=[]);var d={name:c.name,field:c.field,filter:c.filter,order:c.order,url:c.url,sortable:c.sortField,optional:c.optional,checkbox:c.checkbox};d.sortable="false"!==d.sortable,d.optional="true"===d.optional,a.searchColumns.push(d),a.sortSearchColumns()}}}}).controller("SearchResultsCtrl",["$scope","$filter",function(a,b){a.sortSearchColumns=function(){a.searchColumns=b("orderBy")(a.searchColumns,"order")}}]),angular.module("regCartApp").directive("sticky",["$timeout","$window","$document",function(a,b,c){return{restrict:"CA",link:function(d,e,f){a(function(){function d(){p||(n=e.offset().top);var c=l.height()<=e.height(),f=(b.pageYOffset||l.scrollTop())-(l.clientTop||0),j=c;if(!j)if("bottom"===m){var k=n+e.outerHeight(),o=b.innerHeight+f;n&&(i&&n||(i=k),j=i>o,j&&!p&&(i=k))}else i=n,j=f>=i;!p&&j?g():p&&!j&&h(),p&&c&&a(d,500)}function g(){o&&(j||(j=angular.element('<div class="util-sticky-placeholder"/>')),j.css("height",e.outerHeight()+"px"),j.insertBefore(e)),e.addClass("util-sticky--stuck"),p=!0}function h(){j&&(j.remove(),j=null),e.removeClass("util-sticky--stuck"),p=!1}var i,j,k=angular.element(b),l=angular.element(c),m="bottom"===f.sticky?"bottom":"top",n=e.offset().top,o=!angular.isDefined(f.usePlaceholder)||f.usePlaceholder?!0:!1,p=!1;e.addClass("util-sticky"),e.addClass("util-sticky-"+m),k.on("scroll",d),k.on("resize",function(){a(d)}),d(),e.bind("$destroy",function(){j&&(j.remove(),j=null)})})}}}]);